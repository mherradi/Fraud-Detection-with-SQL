/*
==============================================================================================================================================================
Quality Checks
==============================================================================================================================================================

Script Purpose:
This script performs various quality checks for data consistency, accuracy,
and standardization across the 'silver' schemas. It includes checks for:
- Null or duplicate primary keys.
- Unwanted spaces in string fields.
- Data standardization and consistency.
- Invalid date ranges and orders.
- Data consistency between related fields.

Usage Notes:
- Run these checks after data loading Silver Layer.
- Investigate and resolve any discrepancies found duriathe checks.

==============================================================================================================================================================

*/﻿



/* =========================================================== card_holder Table  ============================================================================ */

select * from bronze.card_holder ;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select 
	id ,
	count(*) as 'count'

from
	bronze.card_holder

group by
	id

Having
	count(*) > 1 or id is null



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Unwanted Spaces
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select *

from
	bronze.card_holder

where
	name != trim(name)






/* =========================================================== credit_card Table  ============================================================================ */

select * from bronze.credit_card ;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select 
	card ,
	count(*) as 'count'

from
	bronze.credit_card

group by
	bronze.credit_card.card

Having

	count(*) > 1 or card is null ;


select *
	
from

	bronze.credit_card

where

	id_card_holder is null ;




-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Standarized Data 
-------------------------------------------------------------------------------------------------------------------------------------------------------


select
    id_card_holder,
    card_raw = card,
    -- convert float → decimal → varchar(16)
    card_clean = convert(varchar(25), convert(decimal(38,0), card))
from bronze.credit_card;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------

select
	id_card_holder

from
	bronze.credit_card

where
	id_card_holder not in (select id from bronze.card_holder)




/* =========================================================== merchant Table  ============================================================================ */

select * from bronze.merchant ;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select  
	id ,
	count(*)

from
	bronze.merchant

group by
	id

having 
	count(*) > 1 or id is null ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Unwanted Spaces
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------


select
	name 

from
	bronze.merchant

where
	name != trim(name) ;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------


select
	id_merchant_category

from
	bronze.merchant

where
	id_merchant_category not in (select id from bronze.merchant_category) ;




/* ====================================================== merchant_category Table  ============================================================================ */

select * from bronze.merchant_category;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select
	id ,
	count(*) 'count'

from
	bronze.merchant_category

group by
	id

having
	count(*) > 1 or id is null ;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Unwanted Spaces
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select
	name ,
	trim(name) trimmed_name

from
	bronze.merchant_category

where
	name != trim(name) ;




/* =========================================================== transactions Table  ============================================================================ */

select * from bronze.transactions;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select
	id ,
	count(*) 'count'

from
	bronze.transactions

group by
	id

having
	count(*) > 1 or id is null ;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Invalied Dates
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------


select 
    transaction_dt

from 
	bronze.transactions

where 
	len(transaction_dt) != 10 
    OR transaction_dt < '1900-01-01'
    OR transaction_dt > '2050-01-01';


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Negative Amount
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select
	*
from
	bronze.transactions 

where
	amount is null or amount < 0 ;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check  Merchant Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------


select
	*

from
	bronze.transactions

where
	id_merchant not in (select id from bronze.merchant) ;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check  Card Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------



select

	 distinct SUBSTRING(convert(varchar(25), card)  ,0 , 5) transactions_card

from
	bronze.transactions 

where
	SUBSTRING(convert(varchar(25), card)  ,0 , 5) not in (
	
	
	select
		SUBSTRING(convert(varchar(25), convert(decimal(38,0), card)) ,0,5)
	from	
		bronze.credit_card
	
	)





